<!--
  Â©2018-2019 EdgeVerve Systems Limited (a fully owned Infosys subsidiary),
  Bangalore, India. All Rights Reserved.
-->
<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../oe-utils/oe-common-behaviors.html">
<link rel="import" href="oe-model-handler.html">
<!--
`OEUtils.DraftBehavior` behavior is intended to perform all the drafing related to draftData 
Model responsibilities, like save, load and delete.

When 'draftId' property of the current element changes , The behavior
Loads the respective draftData Model record and sets the current Model's instance
and the elements properties.

To save data into draftData model 'saveDraft' function needs to be called with 
  1)componentData - key-value pair of current element's properties ex:currentStep.
                    In case the parameter is not provided It is generated from the '_draftConfig.componentProps' property
                    To get the properties to be saved.

  2)options       - key-value pair to be saved in the draftData model used primarily for fetching the record.

  3)next          - callback function to be called after data is drafted.

Once the form is submitted using modelHandler behavior's doSave or doSubmit the corresponding draftData is deleted.
-->
<script>
  var OEUtils = OEUtils || {};
  /* @polymerBehavior */
  OEUtils.DraftImpl = {
    properties: {
      draftId: {
        type: String,
        observer: '_draftIdChanged'
      },
      _draftConfig: {
        type: Object,
        value: function () {
          return {
            componentProps: [],
            options: {}
          }
        }
      }
    },
    attached: function () {
      this.use('postInsert', this.deleteDraft);
    },
    _draftIdChanged: function (oldVal, newVal) {
      if (this.draftId) {
        this.loadDraft(this.draftId);
      }
    },
    loadDraft: function (id, next) {
      var modelAlias = this.modelAlias;
      this.makeAjaxCall('api/DraftData/' + id, 'GET', null, null, null, null, function (err, resp) {
        if (err) {
          this.resolveError(err);
        } else {
          this.draftInstance = resp;
          this.set(modelAlias, resp.modelData);
          if (!this.isObjectEmpty(resp.componentData)) {
            Object.keys(resp.componentData).forEach(function (key) {
              this.set(key, resp.componentData[key])
            }.bind(this))
          }
          this.fire('oe-show-success', 'Draft loaded saved successfully.');
          if (next) {
            next()
          }
        }
      }.bind(this));
    },
    _getComponentData: function () {
      if (this._draftConfig && this._draftConfig.componentProps && Array.isArray(this._draftConfig.componentProps)) {
        var obj = {};
        this._draftConfig.componentProps.forEach(function (prop) {
          obj[prop] = this[prop]
        }.bind(this));
        return obj;
      } else {
        return {}
      }
    },
    _getDraftOptions: function () {
      if (this._draftConfig && this._draftConfig.options) {
        return this._draftConfig.options;
      } else {
        return {}
      }
    },
    saveDraft: function (componentData, options, next) {
      componentData = componentData || this._getComponentData();
      options = options || this._getDraftOptions();
      var modelAlias = this.modelAlias;
      var instance = this[modelAlias];
      var body = {
        "formName": this.is,
        "modelData": instance,
        "componentData": componentData,
        "options": options
      }

      if (this.draftInstance && !this.isObjectEmpty(this.draftInstance)) {
        body.id = this.draftInstance.id;
        body._version = this.draftInstance._version;
      }
      var method = this.draftInstance && this.draftInstance.id ? 'PUT' : 'POST';

      this.makeAjaxCall('api/DraftData', method, body, null, null, null, function (err, resp) {
        if (err) {
          this.resolveError(err);
        } else {
          this.fire('oe-draft-saved');
          this.set('draftInstance', resp);
          if (next) {
            next()
          }
        }
      }.bind(this));
    },

    deleteDraft: function (response, instance, next) {
      if (this.draftInstance && !this.isObjectEmpty(this.draftInstance)) {
        var url = 'api/DraftData/' + this.draftInstance.id;
        this.makeAjaxCall(url, 'delete', null, null, null, null, function (err, resp) {
          if (err) {
            this.resolveError(err);
          } else {
            this.fire('oe-draft-deleted');
            delete this.draftInstance;
          }
        }.bind(this));
      }
      next(null, response);
    },

    isObjectEmpty: function (obj) {
      return Object.keys(obj).length === 0 && this.obj.constructor === Object;
    }
  }
  OEUtils.DraftBehavior = [OEUtils.DraftImpl,
    OEUtils.AjaxBehavior,
    OEUtils.FormValidationBehavior,
    OEUtils.FormMessagesBehavior,
    OEUtils.ModelHandler
  ]

</script>
