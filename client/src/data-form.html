<dom-module id="data-form">

    <template>

        <style include="shared-styles iron-flex iron-flex-alignment">
            app-header {
                background-color: var(--app-primary-color);
            }

            .nav-menu {
                background-color: var(--app-primary-color);
                color: #fff;
            }

            .main-header {
                border-bottom: 1px solid #ddd;
                background-color: #fff;
                color: #444;
            }


            .search {
                margin: 16px auto;
            }

            .search>paper-button {
                max-width: 200px;
            }

            #search-input {
                width: 300px;
            }


            .heading-2 {
                padding: 0px 32px;
            }

            .record-heading {
                border-top: 1px solid rgba(0, 0, 0, 0.2);
                margin-bottom: 2px;
            }

            .record {
                @apply --layout-horizontal;
                cursor: pointer;
                padding: 0px 16px;
                box-sizing: border-box;
                min-height: 40px;
                border-bottom: 1px solid rgba(0, 0, 0, 0.2);
            }

            .record>* {
                padding: 8px;
            }

            .owner_name_col {
                width: 20%;
            }

            .gis_id_col {
                width: 20%;
            }

            .address_col {
                width: 60%;
                word-wrap: break-word;
                word-break: keep-all;
            }



            .form {
                margin-left: 16px;
            }

            .form-header iron-icon {
                cursor: pointer;
            }

            .form-header label {
                font-size: 20px;
                padding: 16px;
            }

            .form fieldset {
                margin-bottom: 16px;
            }

            .layout-2-col>* {
                width: calc(50% - 32px);
                padding: 0px 16px;
            }

            .savebtn {
                height: 36px;
                position: absolute;
                right: 24px;
                background-color: #ff9e2c;
                ;
                color: white;
                --paper-button-raised-keyboard-focus: {
                    background-color: var(--paper-pink-a200) !important;
                    color: white !important;
                }
                ;
            }
        </style>

        <app-drawer-layout force-narrow>

            <!-- nav panel -->
            <app-drawer id="drawer" slot="drawer">
                <app-header-layout has-scrolling-region>

                    <app-header fixed slot="header">

                        <!-- top toolbar -->
                        <app-toolbar></app-toolbar>

                        <app-toolbar class="title-toolbar nav-title-toolbar">
                            <div class="nav-title">
                                Relief Information Management
                            </div>
                            <paper-item on-tap="logout">Logout</paper-item>
                        </app-toolbar>

                    </app-header>


                    <!-- nav menu -->
                    <iron-selector class="nav-menu" attr-for-selected="name" on-iron-activate="_drawerSelected">
                        <!-- <a name="home" href="/">Home</a>
                    <a name="logout" href="/logout">Logout</a> -->
                        <paper-item on-tap="_resetForm">Reset Form</paper-item>
                    </iron-selector>

                </app-header-layout>
            </app-drawer>


            <app-header-layout>

                <app-header fixed effects="waterfall" class="main-header" slot="header">
                    <!-- top toolbar -->
                    <iron-pages id="pages" selected="[[page]]" attr-for-selected="name">
                        <app-toolbar name="list">
                            <paper-icon-button on-tap="openDrawer" icon="app:menu"></paper-icon-button>
                            <div class="title">Relief Forms Search</div>
                        </app-toolbar>
                        <app-toolbar name="form">
                            <paper-icon-button on-tap="gotolist" icon="icons:arrow-back"></paper-icon-button>
                            <div class="title">Relief Form GIS ([[data.GIS_ID]])</div>
                            <paper-button on-tap="saveForm" class="savebtn" raised>Save</paper-button>
                        </app-toolbar>
                    </iron-pages>

                </app-header>

                <div id="toastcontainer1">
                    <paper-toast id="toast1" class="fit-bottom" text="Saved successfully" duration="4000">
                </div>
                <div id="toastcontainer2">
                    <paper-toast id="toast2" class="fit-bottom" text="Error while saving data, please try again" duration="4000">
                </div>

                <iron-pages flex id="pages" selected="[[page]]" attr-for-selected="name" selected-attribute="page-selected">
                    <div name="list">
                        <div class="search layout horizontal center-center">
                            <paper-input value={{searchstring}} id="search-input" label="Search by name,mobile no or GIS_ID" on-change="dosearch">
                                <iron-icon icon="search" slot="prefix"></iron-icon>
                            </paper-input>
                        </div>
                        <iron-ajax id="fetch" method="GET" content-type="application/json" on-response="_handleFetchSuccess" on-error="_handleFetchError"></iron-ajax>
                        <div class="list-data" hidden=[[!list.length]]>
                            <h2 class="heading-2">Matching records ([[list.length]])</h2>
                            <div class="record record-heading">
                                <span class="owner_name_col">Owner Name</span>
                                <span class="gis_id_col">GIS Id</span>
                                <span class="address_col">Address</span>
                            </div>
                            <template is="dom-repeat" items={{list}}>
                                <paper-item class="record" on-tap="_handleTap">
                                    <span class="owner_name_col">[[item.OWNER_NAM]]</span>
                                    <span class="gis_id_col">[[item.GIS_ID]]</span>
                                    <span class="address_col">[[item.ADDRESS]]</span>
                                </paper-item>
                            </template>
                        </div>

                    </div>
                    <div name="form" class="form">
                        <form>
                            <fieldset>
                                <legend>Personal Information</legend>
                                <div class="layout horizontal layout-2-col wrap">
                                    <paper-input label="Owner Name" value={{data.OWNER_NAM}}></paper-input>
                                    <paper-input label="Building Number" value={{data.BUILDING_N}}></paper-input>
                                    <paper-input label="Address" value={{data.ADDRESS}}></paper-input>
                                    <paper-input label="Ownedres" value={{data.OWNEDREN}}></paper-input>
                                    <paper-input pattern="[0-9]+" label="Mobile no 1" value={{data.MOBILE1}}></paper-input>
                                    <paper-input pattern="[0-9]+" label="Mobile no 2" value={{data.MOBILE2}}></paper-input>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend>Repair Status</legend>
                                <div class="layout horizontal layout-2-col wrap">
                                    <paper-input label="BUISTRUREP" value={{data.BUISTRUREP}}></paper-input>
                                    <paper-input label="Wall repair" value={{data.COMWALREP}}></paper-input>
                                    <paper-input label="Carpet" value={{data.CARPWORK}}></paper-input>
                                    <paper-input label="Electricity" value={{data.ELECWORK}}></paper-input>
                                    <paper-input label="Plumming word" value={{data.PLUMWORK}}></paper-input>
                                    <paper-input label="Well repair" value={{data.WELLREPIRE}}></paper-input>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend>Equipments Status</legend>
                                <div class="layout horizontal layout-2-col wrap">
                                    <paper-input type="number" label="No of Fans" value={{data.NOFAN}}></paper-input>
                                    <paper-input type="number" label="No of lights" value={{data.NOLIGHTS}}></paper-input>
                                    <paper-input type="number" label="No of Cot" value={{data.COT}}></paper-input>
                                    <paper-input type="number" label="No of chair" value={{data.CHAIR}}></paper-input>
                                    <paper-input type="number" label="No of tables" value={{data.NOTAB}}></paper-input>
                                    <paper-input type="number" label="No of matress" value={{data.MATRESS}}></paper-input>
                                </div>
                            </fieldset>
                        </form>
                    </div>
                </iron-pages>
                <iron-ajax id="xhr" content-type="application/json" handle-as="json" on-response="handleResponse" on-error="handleError"></iron-ajax>
            </app-header-layout>
        </app-drawer-layout>


    </template>

    <script>
        Polymer({

            is: 'data-form',

            properties: {
                searchstring: {
                    type: String
                },
                list: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                }
            },
            logout : function() {
                localStorage.removeItem("auth_token");
                location.href = "/";
            },
            openDrawer: function () {
                //this.fire('app-open-drawer');
                this.$.drawer.open();
            },
            attached: function () {
                this.set('page', 'list');
                this.$.toast1.fitInto = this.$.toastcontainer1;
                this.$.toast2.fitInto = this.$.toastcontainer2;
            },
            gotolist: function () {
                this.set('page', 'list');
            },
            saveForm: function () {
                var auth_token = localStorage.getItem('auth_token');
                if (this.data.id) {
                    this.$.xhr.method = 'PUT'
                    this.$.xhr.url = "/api/formdata?access_token=" + auth_token;
                } else {
                    this.$.xhr.method = 'POST'
                    this.$.xhr.url = "/api/formdata/"; + this.data.id + "?access_token=" + auth_token;
                }
                this.$.xhr.body = this.data;
                this.$.xhr.generateRequest();
            },
            dosearch: function () {
                if (this.searchstring == "") {
                    this.set('list', []);
                    return;
                }
                if (this.searchstring.length < 3) {
                    //raise toast
                    return;
                }
                var upperString = this.searchstring.toUpperCase();
                var auth_token = localStorage.getItem('auth_token');
                var filter = {};
                var conditions = [];
                if (this.searchstring.length >= 10) {
                    conditions.push({ MOBILE1: this.searchstring });
                    conditions.push({ MOBILE2: this.searchstring });
                }
                conditions.push({ OWNER_NAM: { like: upperString } });
                conditions.push({ OWNER_NAM: { like: this.searchstring } });
                conditions.push({ GIS_ID: { inq: [upperString, this.searchstring] } });
                filter = {
                    where: {
                        or: conditions
                    },
                    limit: 20
                };
                this.$.fetch.url = "/api/formdata?access_token=" + auth_token + "&filter=" + JSON.stringify(filter);
                this.set('loaderVisible', true);
                //this.$.spinner.active = true;
                //this.$.fetch.body = JSON.stringify(body);
                this.$.fetch.generateRequest();
            },
            _handleFetchSuccess: function (e) {
                this.set('list', e.detail.response);
                console.log('number of forms found ', this.list.length);
            },
            _handleFetchError: function (e) {

            },
            _handleTap: function (e) {
                console.log('model ', e.model.item);
                this.set('data', e.model.item);
                this.set('page', 'form');
            },
            handleResponse: function (e) {
                this.$.toast1.open;
                if (e.detail.response) {
                    this.data = e.detail.response;
                }
            },
            handleError: function (e) {
                this.$.toast2.open;
            }
        });
    </script>
</dom-module>